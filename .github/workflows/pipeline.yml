name: Unified Multi-Layer CI/CD

on:
  push:
    branches: [ staging, main ]
  pull_request:
    branches: [ staging, main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Camada de Processamento (C++)
  engine-audit:
    name: Core Engine (DSA & Memory)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nexus-sus-engine
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck valgrind python3
          
      - name: Code Style Check
        run: find . -name "*.cpp" | xargs clang-format --style=file --dry-run -Werror
        
      - name: Static Security Analysis
        run: cppcheck --enable=all --error-exitcode=1 --suppress=missingIncludeSystem .
        
      - name: Compile Engine
        run: g++ -O3 compiler.cpp -o compiler
        
      - name: DSA Stress Test (O(1) Validation)
        run: python3 test_engine.py
        
      - name: Memory Hygiene (Leak Check)
        run: |
          echo "L SP Sudeste 100.0 200.0 300.0 202310 20231101" > input.txt
          echo "Q SP" >> input.txt
          echo "X" >> input.txt
          valgrind --leak-check=full --error-exitcode=1 ./compiler < input.txt

  # 2. Camada de Orquestração (Go)
  api-audit:
    name: Orchestrator API (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Run go mod tidy
        run: go mod tidy
      - name: Lint & Build Check
        run: |
          go fmt ./...
          go build -o api_check .

  # 3. Camada de Ingestão (Python)
  etl-audit:
    name: ETL Pipeline (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nexus-sus-etl
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Format & Lint
        run: |
          pip install black isort
          black .
          isort .
      - name: Auto-Commit Formatting
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-format python code"

  # 4. Camada de Interface (TypeScript)
  frontend-audit:
    name: Frontend (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nexus-sus-frontend
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Build & Type Check
        run: |
          npm install
          npm run build

  # 5. Provisionamento e Deploy (AWS Infra & Containers)
  infra-and-deploy:
    name: Provision & Deploy
    needs: [engine-audit, api-audit, etl-audit, frontend-audit]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Plan & Apply
        working-directory: infra
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_db_username: nexus_admin
          TF_VAR_admin_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
        run: |
          terraform init -reconfigure \
            -backend-config="key=${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}/terraform.tfstate"
          terraform apply -auto-approve

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag and Push Images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
        run: |
          # API & Engine
          docker build -t $ECR_REGISTRY/nexus-sus-api-$ENV:latest -f api/Dockerfile .
          docker push $ECR_REGISTRY/nexus-sus-api-$ENV:latest
          
          # Frontend
          docker build -t $ECR_REGISTRY/nexus-sus-frontend-$ENV:latest ./nexus-sus-frontend
          docker push $ECR_REGISTRY/nexus-sus-frontend-$ENV:latest

      - name: Update ECS Services
        env:
          ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
        run: |
          aws ecs update-service --cluster nexus-sus-cluster-$ENV --service nexus-sus-api-service-$ENV --force-new-deployment
          aws ecs update-service --cluster nexus-sus-cluster-$ENV --service nexus-sus-frontend-service-$ENV --force-new-deployment
