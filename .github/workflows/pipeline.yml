name: Unified Multi-Layer CI/CD

on:
  push:
    branches: [ staging, main ]
  pull_request:
    branches: [ staging, main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Camada de Processamento (C++)
  engine-audit:
    name: Core Engine (DSA & Memory)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nexus-sus-engine
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck valgrind python3
          
      - name: Code Style Check
        run: find . -name "*.cpp" | xargs clang-format --style=file --dry-run -Werror
        
      - name: Static Security Analysis
        run: cppcheck --enable=all --error-exitcode=1 --suppress=missingIncludeSystem .
        
      - name: Compile Engine
        run: g++ -O3 compiler.cpp -o compiler
        
      - name: DSA Stress Test (O(1) Validation)
        run: python3 test_engine.py
        
      - name: Memory Hygiene (Leak Check)
        run: |
          echo "L SP Sudeste 100.0 200.0 300.0 202310 20231101" > input.txt
          echo "Q SP" >> input.txt
          echo "X" >> input.txt
          valgrind --leak-check=full --error-exitcode=1 ./compiler < input.txt

  # 2. Camada de Orquestração (Go)
  api-audit:
    name: Orchestrator API (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Run go mod tidy
        run: go mod tidy
      - name: Lint & Build Check
        run: |
          go fmt ./...
          go build -o api_check .

  # 3. Camada de Ingestão (Python)
  etl-audit:
    name: ETL Pipeline (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nexus-sus-etl
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Format & Lint
        run: |
          pip install black isort
          black .
          isort .
      - name: Auto-Commit Formatting
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-format python code"

  # 4. Camada de Interface (TypeScript)
  frontend-audit:
    name: Frontend (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nexus-sus-frontend
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Build & Type Check
        run: |
          npm install
          npm run build

  # 5. Provisionamento e Deploy (AWS Infra & Containers)
  infra-and-deploy:
    name: Provision & Deploy
    needs: [engine-audit, api-audit, etl-audit, frontend-audit]
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Remove Old DynamoDB Reference
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Deletar a tabela antiga (se existir)
          aws dynamodb delete-table --table-name terraform-locks 2>/dev/null || true
          
          # Aguardar deletion
          sleep 20
          
          echo "✅ Tabela antiga removida"

      - name: Nuclear Clean Cache
        run: |
          # Remover TUDO de terraform na máquina da pipeline
          rm -rf infra/.terraform
          rm -rf infra/.terraform.lock.hcl
          rm -rf infra/terraform.tfstate*
          rm -rf ~/.terraform*
          rm -rf /tmp/terraform*
          
          # Limpar env vars
          unset TF_LOG
          unset TF_LOG_PATH
          unset TF_DATA_DIR
          
          echo "✅ Cache limpo"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
      
      - name: Clean Terraform State
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Force clean slate - Remove estados antigos do S3 e recria a tabela de locks
          aws s3 rm s3://nexus-sus-terraform-state --recursive --include "*.tfstate*" 2>/dev/null || true
          aws dynamodb delete-table --table-name nexus-sus-terraform-locks 2>/dev/null || true
          sleep 5
          aws dynamodb create-table \
            --table-name nexus-sus-terraform-locks \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST 2>/dev/null || true
          sleep 5

      - name: Clean Terraform Cache
        working-directory: infra
        run: |
          # Remove cache local e artefatos de estado
          rm -rf .terraform
          rm -rf .terraform.lock.hcl
          rm -rf terraform.tfstate*
          rm -rf ~/.terraform
          
          # Limpa variáveis de ambiente de credenciais residuais
          unset AWS_PROFILE
          unset AWS_ROLE_ARN

      - name: Terraform Plan & Apply
        working-directory: infra
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_db_username: nexus_admin
          TF_VAR_admin_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
        run: |
          STATE_KEY="${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}/terraform.tfstate"
          
          # Terraform Init (Fresh) - Força atualização de plugins e configuração de backend
          terraform init \
            -backend-config="bucket=nexus-sus-terraform-state" \
            -backend-config="key=$STATE_KEY" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=nexus-sus-terraform-locks" \
            -backend-config="encrypt=true" \
            -reconfigure \
            -upgrade
          
          # Agora que o ambiente está limpo, roda o ciclo completo
          terraform plan -out=tfplan
          terraform apply tfplan

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag and Push Images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
        run: |
          # API & Engine
          docker build -t $ECR_REGISTRY/nexus-sus-api-$ENV:latest -f api/Dockerfile .
          docker push $ECR_REGISTRY/nexus-sus-api-$ENV:latest
          
          # Frontend
          docker build -t $ECR_REGISTRY/nexus-sus-frontend-$ENV:latest ./nexus-sus-frontend
          docker push $ECR_REGISTRY/nexus-sus-frontend-$ENV:latest

      - name: Update ECS Services
        env:
          ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
        run: |
          aws ecs update-service --cluster nexus-sus-cluster-$ENV --service nexus-sus-api-service-$ENV --force-new-deployment
          aws ecs update-service --cluster nexus-sus-cluster-$ENV --service nexus-sus-frontend-service-$ENV --force-new-deployment
