name: üßπ Force Cleanup Orphaned Resources

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Digite "CLEANUP" para confirmar a exclus√£o dos recursos conflitantes'
        required: true
        default: ''

jobs:
  cleanup:
    name: üßπ AWS Resource Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "CLEANUP" ]]; then
            echo "‚ùå Confirma√ß√£o inv√°lida. Digite CLEANUP para prosseguir."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Delete Orphaned Resources
        run: |
          echo "üöÄ Iniciando limpeza de recursos √≥rf√£os..."

          # Fun√ß√µes auxiliares para n√£o falhar o script se o recurso n√£o existir
          delete_ecr() {
            repo=$1
            echo "üóëÔ∏è Verificando ECR: $repo"
            aws ecr delete-repository --repository-name $repo --force 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_rds_subnet() {
            name=$1
            echo "üóëÔ∏è Verificando RDS Subnet Group: $name"
            aws rds delete-db-subnet-group --db-subnet-group-name $name 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_rds_param() {
            name=$1
            echo "üóëÔ∏è Verificando RDS Param Group: $name"
            aws rds delete-db-parameter-group --db-parameter-group-name $name 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_s3() {
            bucket=$1
            echo "üóëÔ∏è Verificando S3 Bucket: $bucket"
            # Tenta esvaziar primeiro
            aws s3 rm s3://$bucket --recursive 2>/dev/null || true
            aws s3 rb s3://$bucket --force 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_iam_role() {
            role=$1
            echo "üóëÔ∏è Verificando IAM Role: $role"
            # Remove policies anexadas antes
            policies=$(aws iam list-attached-role-policies --role-name $role --query 'AttachedPolicies[*].PolicyArn' --output text 2>/dev/null || true)
            for policy in $policies; do
              aws iam detach-role-policy --role-name $role --policy-arn $policy 2>/dev/null || true
            done
            aws iam delete-role --role-name $role 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }


          # 1. Limpar ECR Repos (nomes antigos e staging)
          echo "üì¶ Limpando ECR Repositories..."
          repos=("nexus-sus-etl" "nexus-sus-frontend" "nexus-sus-engine" "nexus-sus-api")
          for repo in "${repos[@]}"; do
            delete_ecr "$repo"
            delete_ecr "$repo-staging"
          done

          # 2. Limpar RDS (antigos e staging)
          echo "üóÑÔ∏è Limpando RDS..."
          delete_rds_subnet "nexus-sus-db-subnet-group"
          delete_rds_subnet "nexus-sus-db-subnet-group-staging"
          
          delete_rds_param "nexus-sus-postgres-params"
          delete_rds_param "nexus-sus-postgres-params-staging"

          # 3. Limpar S3 (antigos e staging)
          echo "ü™£ Limpando S3..."
          delete_s3 "nexus-sus-data-lake"
          delete_s3 "nexus-sus-data-lake-staging"

          # 4. Limpar IAM (antigos e staging)
          echo "üîë Limpando IAM..."
          delete_iam_role "nexus-sus-etl-role"
          delete_iam_role "nexus-sus-etl-role-staging"
          
          # Limpar Policies √ìrf√£s
          echo "üìú Limpando Policies..."
          policies=(
            "nexus-sus-etl-s3-read-policy" "nexus-sus-etl-s3-read-policy-staging"
            "nexus-sus-etl-s3-write-policy" "nexus-sus-etl-s3-write-policy-staging"
            "nexus-sus-etl-ecr-access-policy" "nexus-sus-etl-ecr-access-policy-staging"
          )
          
          for policy_name in "${policies[@]}"; do
             echo "üóëÔ∏è Verificando Policy: $policy_name"
             arn=$(aws iam list-policies --query "Policies[?PolicyName=='$policy_name'].Arn" --output text 2>/dev/null)
             
             if [[ -n "$arn" && "$arn" != "None" ]]; then
                echo "   Encontrada ARN: $arn"
                # Detach de todas as roles/users/groups (opcional, mas seguro)
                aws iam delete-policy --policy-arn "$arn" 2>/dev/null && echo "   ‚úÖ Deletada" || echo "   ‚ö†Ô∏è Erro ao deletar"
             else
                echo "   ‚ö†Ô∏è N√£o encontrada"
             fi
          done
