name: ğŸ§¹ Force Cleanup Orphaned Resources

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Digite "CLEANUP" para confirmar a exclusÃ£o dos recursos conflitantes'
        required: true
        default: ''

jobs:
  cleanup:
    name: ğŸ§¹ AWS Resource Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "CLEANUP" ]]; then
            echo "âŒ ConfirmaÃ§Ã£o invÃ¡lida. Digite CLEANUP para prosseguir."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Delete Orphaned Resources
        run: |
          echo "ğŸš€ Iniciando limpeza de recursos Ã³rfÃ£os..."

          # FunÃ§Ãµes auxiliares com variÃ¡veis locais para evitar colisÃµes
          delete_ecr() {
            local rname=$1
            echo "ğŸ—‘ï¸ Verificando ECR: $rname"
            aws ecr delete-repository --repository-name "$rname" --force 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado"
          }

          delete_rds_subnet() {
            local sname=$1
            echo "ğŸ—‘ï¸ Verificando RDS Subnet Group: $sname"
            aws rds delete-db-subnet-group --db-subnet-group-name "$sname" 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado"
          }

          delete_rds_param() {
            local pname=$1
            echo "ğŸ—‘ï¸ Verificando RDS Param Group: $pname"
            aws rds delete-db-parameter-group --db-parameter-group-name "$pname" 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado"
          }

          delete_s3() {
            local bname=$1
            echo "ğŸ—‘ï¸ Verificando S3 Bucket: $bname"
            aws s3 rm "s3://$bname" --recursive 2>/dev/null || true
            aws s3 rb "s3://$bname" --force 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado"
          }

          delete_iam_role() {
            local rname=$1
            echo "ğŸ—‘ï¸ Verificando IAM Role: $rname"
            local attached_policies=$(aws iam list-attached-role-policies --role-name "$rname" --query 'AttachedPolicies[*].PolicyArn' --output text 2>/dev/null || true)
            for policy in $attached_policies; do
              aws iam detach-role-policy --role-name "$rname" --policy-arn "$policy" 2>/dev/null || true
            done
            aws iam delete-role --role-name "$rname" 2>/dev/null && echo "   âœ… Deletada" || echo "   âš ï¸ NÃ£o encontrada"
          }

          detach_and_delete_policy() {
            local pname=$1
            echo "ğŸ—‘ï¸ Verificando Policy: $pname"
            local arn=$(aws iam list-policies --scope Local --query "Policies[?PolicyName=='$pname'].Arn" --output text 2>/dev/null)
            if [[ -n "$arn" && "$arn" != "None" ]]; then
              # Detach de todas as roles associadas
              local roles=$(aws iam list-entities-for-policy --policy-arn "$arn" --entity-filter Role --query 'PolicyRoles[*].RoleName' --output text 2>/dev/null)
              for r in $roles; do
                aws iam detach-role-policy --role-name "$r" --policy-arn "$arn" 2>/dev/null
              done
              aws iam delete-policy --policy-arn "$arn" 2>/dev/null && echo "   âœ… Deletada" || echo "   âš ï¸ Erro ao deletar"
            else
              echo "   âš ï¸ NÃ£o encontrada"
            fi
          }

          # 1. ECR Repos
          echo "ğŸ“¦ Limpando ECR Repositories..."
          for itm in "nexus-sus-etl" "nexus-sus-frontend" "nexus-sus-engine" "nexus-sus-api"; do
            delete_ecr "$itm-staging"
            delete_ecr "$itm-prod"
          done

          # 2. RDS Groups
          echo "ğŸ—„ï¸ Limpando RDS Groups..."
          for env_name in "staging" "prod"; do
            delete_rds_subnet "nexus-sus-db-subnet-group-$env_name"
            delete_rds_param "nexus-sus-postgres-params-$env_name"
          done

          # 3. S3
          echo "ğŸª£ Limpando S3..."
          delete_s3 "nexus-sus-data-lake-staging"
          delete_s3 "nexus-sus-data-lake-prod"

          # 4. IAM Roles
          echo "ğŸ”‘ Limpando IAM Roles..."
          for rl in "nexus-sus-etl-role" "nexus-sus-ecs-task-execution-role" "nexus-sus-ecs-task-role"; do
            delete_iam_role "$rl-staging"
            delete_iam_role "$rl-prod"
          done
          
          # 5. IAM Policies
          echo "ğŸ“œ Limpando Policies..."
          for pbase in "nexus-sus-etl-s3-read-policy" "nexus-sus-etl-s3-write-policy" "nexus-sus-etl-ecr-access-policy" "nexus-sus-ecs-logging-policy"; do
            for env_name in "staging" "prod"; do
              detach_and_delete_policy "$pbase-$env_name"
            done
          done

          # 6. VPCs e Redes (Melhorado)
          echo "ğŸŒ Limpando VPCs e Redes Ã“rfÃ£s..."
          current_vpcs=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=nexus-sus-vpc*" --query 'Vpcs[*].VpcId' --output text)
          for v_id in $current_vpcs; do
            echo "ğŸ”¥ Destruindo VPC: $v_id"
            
            # 6.1 VPC Endpoints (INTERFACE e GATEWAY)
            echo "   â³ Verificando VPC Endpoints..."
            endpoints=$(aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$v_id" --query 'VpcEndpoints[*].VpcEndpointId' --output text 2>/dev/null)
            for vpce in $endpoints; do
              echo "   ğŸ—‘ï¸ Deletando VPC Endpoint: $vpce"
              aws ec2 delete-vpc-endpoints --vpc-endpoint-ids "$vpce" 2>/dev/null
            done
            if [[ -n "$endpoints" ]]; then sleep 15; fi

            # 6.2 Load Balancers
            echo "   â³ Verificando Load Balancers..."
            elbs=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$v_id'].LoadBalancerArn" --output text 2>/dev/null)
            for elb in $elbs; do
              echo "   ğŸ—‘ï¸ Deletando ELB: $elb"
              aws elbv2 delete-load-balancer --load-balancer-arn "$elb" 2>/dev/null
            done
            if [[ -n "$elbs" ]]; then sleep 30; fi

            # 6.3 NAT Gateways
            echo "   â³ Verificando NAT Gateways..."
            nat_gws=$(aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=$v_id" --query "NatGateways[?State!='deleted'].NatGatewayId" --output text 2>/dev/null)
            for nat in $nat_gws; do
              echo "   ğŸ—‘ï¸ Deletando NAT Gateway: $nat"
              aws ec2 delete-nat-gateway --nat-gateway-id "$nat" 2>/dev/null
            done
            if [[ -n "$nat_gws" ]]; then sleep 60; fi

            # 6.4 Security Groups (menos o default)
            echo "   ğŸ—‘ï¸ Limpando Security Groups..."
            sgs=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$v_id" --query "SecurityGroups[?GroupName!='default'].GroupId" --output text)
            for sg in $sgs; do
               aws ec2 delete-security-group --group-id "$sg" 2>/dev/null && echo "   âœ… SG $sg removido"
            done

            # 6.5 ENIs (Interfaces de Rede)
            echo "   ğŸ—‘ï¸ Limpando interfaces de Rede (ENIs)..."
            enis=$(aws ec2 describe-network-interfaces --filters "Name=vpc-id,Values=$v_id" --query 'NetworkInterfaces[*].NetworkInterfaceId' --output text)
            for eni in $enis; do
              att_id=$(aws ec2 describe-network-interfaces --network-interface-ids "$eni" --query 'NetworkInterfaces[0].Attachment.AttachmentId' --output text 2>/dev/null)
              if [[ "$att_id" != "None" && -n "$att_id" ]]; then
                aws ec2 detach-network-interface --attachment-id "$att_id" --force 2>/dev/null || true
              fi
              aws ec2 delete-network-interface --network-interface-id "$eni" 2>/dev/null && echo "   âœ… ENI $eni removida"
            done

            # 6.6 Internet Gateways
            echo "   ğŸ—‘ï¸ Limpando Internet Gateways..."
            igws=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$v_id" --query 'InternetGateways[*].InternetGatewayId' --output text)
            for ig_id in $igws; do
              aws ec2 detach-internet-gateway --internet-gateway-id "$ig_id" --vpc-id "$v_id" 2>/dev/null
              aws ec2 delete-internet-gateway --internet-gateway-id "$ig_id" 2>/dev/null && echo "   âœ… IGW $ig_id removido"
            done

            # 6.7 Subnets (Mostrando Erros!)
            echo "   ğŸ—‘ï¸ Limpando Subnets..."
            subs=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$v_id" --query 'Subnets[*].SubnetId' --output text)
            for s_id in $subs; do
              echo "   Excluindo Subnet: $s_id"
              aws ec2 delete-subnet --subnet-id "$s_id" && echo "      âœ… Sucesso" || echo "      âŒ Erro ao deletar subnet. ProvÃ¡vel dependÃªncia oculta."
            done

            # 6.8 VPC finalize
            echo "   ğŸ’£ Finalizando exclusÃ£o da VPC: $v_id"
            aws ec2 delete-vpc --vpc-id "$v_id" && echo "   â­ VPC $v_id Removida com sucesso!" || echo "   âš ï¸ Erro residual ao remover VPC $v_id. Tente novamente em 2 minutos."
          done
          echo "âœ¨ Limpeza concluÃ­da!"
