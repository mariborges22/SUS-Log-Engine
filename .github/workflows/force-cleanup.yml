name: üßπ Force Cleanup Orphaned Resources

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Digite "CLEANUP" para confirmar a exclus√£o dos recursos conflitantes'
        required: true
        default: ''

jobs:
  cleanup:
    name: üßπ AWS Resource Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "CLEANUP" ]]; then
            echo "‚ùå Confirma√ß√£o inv√°lida. Digite CLEANUP para prosseguir."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Delete Orphaned Resources
        run: |
          echo "üöÄ Iniciando limpeza de recursos √≥rf√£os..."

          # Fun√ß√µes auxiliares para n√£o falhar o script se o recurso n√£o existir
          delete_ecr() {
            repo=$1
            echo "üóëÔ∏è Verificando ECR: $repo"
            aws ecr delete-repository --repository-name $repo --force 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_rds_subnet() {
            name=$1
            echo "üóëÔ∏è Verificando RDS Subnet Group: $name"
            aws rds delete-db-subnet-group --db-subnet-group-name $name 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_rds_param() {
            name=$1
            echo "üóëÔ∏è Verificando RDS Param Group: $name"
            aws rds delete-db-parameter-group --db-parameter-group-name $name 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_s3() {
            bucket=$1
            echo "üóëÔ∏è Verificando S3 Bucket: $bucket"
            aws s3 rm s3://$bucket --recursive 2>/dev/null || true
            aws s3 rb s3://$bucket --force 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          delete_iam_role() {
            role=$1
            echo "üóëÔ∏è Verificando IAM Role: $role"
            policies=$(aws iam list-attached-role-policies --role-name $role --query 'AttachedPolicies[*].PolicyArn' --output text 2>/dev/null || true)
            for policy in $policies; do
              aws iam detach-role-policy --role-name $role --policy-arn $policy 2>/dev/null || true
            done
            aws iam delete-role --role-name $role 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado ou erro"
          }

          # 1. Limpar ECR Repos (staging e prod)
          echo "üì¶ Limpando ECR Repositories..."
          repos=("nexus-sus-etl" "nexus-sus-frontend" "nexus-sus-engine" "nexus-sus-api")
          for repo in "${repos[@]}"; do
            delete_ecr "$repo-staging"
            delete_ecr "$repo-prod"
          done

          # 2. Limpar RDS
          echo "üóÑÔ∏è Limpando RDS Groups..."
          for env in "staging" "prod"; do
            delete_rds_subnet "nexus-sus-db-subnet-group-$env"
            delete_rds_param "nexus-sus-postgres-params-$env"
          done

          # 3. Limpar S3
          echo "ü™£ Limpando S3..."
          delete_s3 "nexus-sus-data-lake-staging"
          delete_s3 "nexus-sus-data-lake-prod"

          # 4. Limpar IAM
          echo "üîë Limpando IAM Roles..."
          roles=("nexus-sus-etl-role" "nexus-sus-ecs-task-execution-role" "nexus-sus-ecs-task-role")
          for role in "${roles[@]}"; do
            delete_iam_role "$role-staging"
            delete_iam_role "$role-prod"
          done
          
          # 5. Limpar Policies
          echo "üìú Limpando Policies..."
          policies=(
            "nexus-sus-etl-s3-read-policy" "nexus-sus-etl-s3-write-policy" "nexus-sus-etl-ecr-access-policy"
            "nexus-sus-ecs-logging-policy"
          )
          for policy_name in "${policies[@]}"; do
            for env in "staging" "prod"; do
              pname="$policy_name-$env"
              echo "üóëÔ∏è Verificando Policy: $pname"
              arn=$(aws iam list-policies --scope Local --query "Policies[?PolicyName=='$pname'].Arn" --output text 2>/dev/null)
              if [[ -n "$arn" && "$arn" != "None" ]]; then
                aws iam delete-policy --policy-arn "$arn" 2>/dev/null && echo "   ‚úÖ Deletada" || echo "   ‚ö†Ô∏è Erro ao deletar"
              fi
            done
          done

          # 6. Limpar VPCs e Depend√™ncias (CUIDADO!)
          echo "üåê Limpando VPCs e Redes √ìrf√£s..."
          vpcs=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=nexus-sus-vpc*" --query 'Vpcs[*].VpcId' --output text)
          for vpc in $vpcs; do
            echo "üî• Destruindo VPC: $vpc"
            # IGWs
            igws=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$vpc" --query 'InternetGateways[*].InternetGatewayId' --output text)
            for igw in $igws; do
              aws ec2 detach-internet-gateway --internet-gateway-id $igw --vpc-id $vpc 2>/dev/null
              aws ec2 delete-internet-gateway --internet-gateway-id $igw 2>/dev/null
            done
            # Subnets
            subnets=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$vpc" --query 'Subnets[*].SubnetId' --output text)
            for sub in $subnets; do
              aws ec2 delete-subnet --subnet-id $sub 2>/dev/null
            done
            # VPC
            aws ec2 delete-vpc --vpc-id $vpc 2>/dev/null && echo "   ‚úÖ VPC Removida" || echo "   ‚ö†Ô∏è Erro (check dependencies)"
          done
