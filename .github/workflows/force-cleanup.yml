name: üßπ Force Cleanup Orphaned Resources

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Digite "CLEANUP" para confirmar a exclus√£o dos recursos conflitantes'
        required: true
        default: ''

jobs:
  cleanup:
    name: üßπ AWS Resource Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "CLEANUP" ]]; then
            echo "‚ùå Confirma√ß√£o inv√°lida. Digite CLEANUP para prosseguir."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Delete Orphaned Resources
        run: |
          echo "üöÄ Iniciando limpeza de recursos √≥rf√£os..."

          # Fun√ß√µes auxiliares com vari√°veis locais para evitar colis√µes
          delete_ecr() {
            local rname=$1
            echo "üóëÔ∏è Verificando ECR: $rname"
            aws ecr delete-repository --repository-name "$rname" --force 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado"
          }

          delete_rds_subnet() {
            local sname=$1
            echo "üóëÔ∏è Verificando RDS Subnet Group: $sname"
            aws rds delete-db-subnet-group --db-subnet-group-name "$sname" 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado"
          }

          delete_rds_param() {
            local pname=$1
            echo "üóëÔ∏è Verificando RDS Param Group: $pname"
            aws rds delete-db-parameter-group --db-parameter-group-name "$pname" 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado"
          }

          delete_s3() {
            local bname=$1
            echo "üóëÔ∏è Verificando S3 Bucket: $bname"
            aws s3 rm "s3://$bname" --recursive 2>/dev/null || true
            aws s3 rb "s3://$bname" --force 2>/dev/null && echo "   ‚úÖ Deletado" || echo "   ‚ö†Ô∏è N√£o encontrado"
          }

          delete_iam_role() {
            local rname=$1
            echo "üóëÔ∏è Verificando IAM Role: $rname"
            local attached_policies=$(aws iam list-attached-role-policies --role-name "$rname" --query 'AttachedPolicies[*].PolicyArn' --output text 2>/dev/null || true)
            for policy in $attached_policies; do
              aws iam detach-role-policy --role-name "$rname" --policy-arn "$policy" 2>/dev/null || true
            done
            aws iam delete-role --role-name "$rname" 2>/dev/null && echo "   ‚úÖ Deletada" || echo "   ‚ö†Ô∏è N√£o encontrada"
          }

          detach_and_delete_policy() {
            local pname=$1
            echo "üóëÔ∏è Verificando Policy: $pname"
            local arn=$(aws iam list-policies --scope Local --query "Policies[?PolicyName=='$pname'].Arn" --output text 2>/dev/null)
            if [[ -n "$arn" && "$arn" != "None" ]]; then
              # Detach de todas as roles associadas
              local roles=$(aws iam list-entities-for-policy --policy-arn "$arn" --entity-filter Role --query 'PolicyRoles[*].RoleName' --output text 2>/dev/null)
              for r in $roles; do
                aws iam detach-role-policy --role-name "$r" --policy-arn "$arn" 2>/dev/null
              done
              aws iam delete-policy --policy-arn "$arn" 2>/dev/null && echo "   ‚úÖ Deletada" || echo "   ‚ö†Ô∏è Erro ao deletar"
            else
              echo "   ‚ö†Ô∏è N√£o encontrada"
            fi
          }

          # --- FASE 1: Global Discovery Clean (Recursos sem VPC ou Multi-VPC) ---
          
          # 1. ECR Repos (Discovery)
          echo "üì¶ Limpando ECR (Discovery)..."
          all_repos=$(aws ecr describe-repositories --query "repositories[?starts_with(repositoryName, 'nexus-sus')].repositoryName" --output text 2>/dev/null)
          for repo in $all_repos; do
            delete_ecr "$repo"
          done

          # 2. State Backend (The Soul Clean - CORRE√á√ÉO DE CHECKSUM)
          echo "üîÑ Limpando State Backend (DynamoDB Locks)..."
          lock_table="nexus-sus-terraform-locks"
          bucket_name="nexus-sus-terraform-state"
          for state_key in "terraform.tfstate" "staging/terraform.tfstate" "prod/terraform.tfstate"; do
            echo "   üèÅ Resetando Digest: $state_key"
            aws dynamodb delete-item --table-name "$lock_table" --key "{\"LockID\": {\"S\": \"$bucket_name/$state_key-md5\"}}" 2>/dev/null || true
            aws dynamodb delete-item --table-name "$lock_table" --key "{\"LockID\": {\"S\": \"$bucket_name/$state_key\"}}" 2>/dev/null || true
          done

          # 3. ELB & Target Groups (Discovery Global - v9)
          echo "‚öñÔ∏è Limpando Load Balancers e Target Groups (Global Discovery)..."
          # ALB/NLB
          all_elbs_v2=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?starts_with(LoadBalancerName, 'nexus-sus')].LoadBalancerArn" --output text 2>/dev/null)
          for elb in $all_elbs_v2; do
            echo "   üóëÔ∏è Deletando ALB/NLB: $elb"
            aws elbv2 delete-load-balancer --load-balancer-arn "$elb" 2>/dev/null || true
          done
          # Classic ELB
          all_elbs_v1=$(aws elb describe-load-balancers --query "LoadBalancerDescriptions[?starts_with(LoadBalancerName, 'nexus-sus')].LoadBalancerName" --output text 2>/dev/null)
          for elb in $all_elbs_v1; do
            echo "   üóëÔ∏è Deletando Classic ELB: $elb"
            aws elb delete-load-balancer --load-balancer-name "$elb" 2>/dev/null || true
          done
          # Target Groups (O GRANDE VIL√ÉO DO APPLY)
          all_tgs=$(aws elbv2 describe-target-groups --query "TargetGroups[?starts_with(TargetGroupName, 'nexus-sus')].TargetGroupArn" --output text 2>/dev/null)
          for tg in $all_tgs; do
            echo "   ÔøΩÔ∏è Deletando Target Group: $tg"
            aws elbv2 delete-target-group --target-group-arn "$tg" 2>/dev/null || true
          done

          # 4. RDS (Discovery)
          echo "üóÑÔ∏è Limpando RDS (Discovery)..."
          all_rds=$(aws rds describe-db-instances --query "DBInstances[?starts_with(DBInstanceIdentifier, 'nexus-sus')].DBInstanceIdentifier" --output text 2>/dev/null)
          for db in $all_rds; do
            echo "   üóëÔ∏è Deletando RDS Instance: $db"
            aws rds delete-db-instance --db-instance-identifier "$db" --skip-final-snapshot 2>/dev/null || true
          done
          all_rds_sngs=$(aws rds describe-db-subnet-groups --query "DBSubnetGroups[?starts_with(DBSubnetGroupName, 'nexus-sus')].DBSubnetGroupName" --output text 2>/dev/null)
          for sng in $all_rds_sngs; do
            echo "   üóëÔ∏è Deletando RDS Subnet Group: $sng"
            aws rds delete-db-subnet-group --db-subnet-group-name "$sng" 2>/dev/null || true
          done

          # 5. S3 (Discovery)
          echo "ü™£ Limpando S3 (Discovery)..."
          all_buckets=$(aws s3api list-buckets --query "Buckets[?starts_with(Name, 'nexus-sus')].Name" --output text 2>/dev/null)
          for bkt in $all_buckets; do
            delete_s3 "$bkt"
          done

          # 6. ECS (Discovery)
          echo "üö¢ Limpando ECS (Discovery)..."
          all_clusters=$(aws ecs list-clusters --query "clusterArns[*]" --output text 2>/dev/null)
          for cls in $all_clusters; do
            if [[ "$cls" == *"nexus-sus"* ]]; then
              echo "   üóëÔ∏è Processando Cluster ECS: $cls"
              svcs=$(aws ecs list-services --cluster "$cls" --query "serviceArns[*]" --output text 2>/dev/null)
              for svc in $svcs; do
                echo "      üóëÔ∏è Deletando Servi√ßo: $svc"
                aws ecs update-service --cluster "$cls" --service "$svc" --desired-count 0 2>/dev/null || true
                aws ecs delete-service --cluster "$cls" --service "$svc" --force 2>/dev/null || true
              done
              tasks=$(aws ecs list-tasks --cluster "$cls" --query "taskArns[*]" --output text 2>/dev/null)
              for tsk in $tasks; do
                echo "      üõë Parando Tarefa: $tsk"
                aws ecs stop-task --cluster "$cls" --task "$tsk" 2>/dev/null || true
              done
              aws ecs delete-cluster --cluster "$cls" 2>/dev/null || true
            fi
          done

          # 7. IAM (Discovery)
          echo "üîë Limpando IAM (Discovery)..."
          all_roles=$(aws iam list-roles --query "Roles[?starts_with(RoleName, 'nexus-sus')].RoleName" --output text 2>/dev/null)
          for rl_name in $all_roles; do
            delete_iam_role "$rl_name"
          done
          all_policies=$(aws iam list-policies --scope Local --query "Policies[?starts_with(PolicyName, 'nexus-sus')].PolicyName" --output text 2>/dev/null)
          for pol_name in $all_policies; do
            detach_and_delete_policy "$pol_name"
          done

          # --- FASE 2: Network Clean (VPCs e Subnets) ---
          echo "üåê Limpando VPCs e Redes √ìrf√£s (v9)..."
          current_vpcs=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=nexus-sus-vpc*" --query 'Vpcs[*].VpcId' --output text)
          for v_id in $current_vpcs; do
            echo "üî• Destruindo VPC: $v_id"
            
            # 6.1 VPC Endpoints
            echo "   ‚è≥ Verificando VPC Endpoints..."
            endpoints=$(aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$v_id" --query 'VpcEndpoints[*].VpcEndpointId' --output text 2>/dev/null)
            for vpce in $endpoints; do
              echo "   üóëÔ∏è Deletando VPC Endpoint: $vpce"
              aws ec2 delete-vpc-endpoints --vpc-endpoint-ids "$vpce" 2>/dev/null
            done
            if [[ -n "$endpoints" ]]; then sleep 15; fi

            # 6.2 Load Balancers (ALB/NLB e Classic)
            echo "   ‚è≥ Verificando Load Balancers..."
            elbs_v2=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$v_id'].LoadBalancerArn" --output text 2>/dev/null)
            for elb in $elbs_v2; do
              echo "   üóëÔ∏è Deletando ALB/NLB: $elb"
              aws elbv2 delete-load-balancer --load-balancer-arn "$elb" 2>/dev/null
            done
            elbs_v1=$(aws elb describe-load-balancers --query "LoadBalancerDescriptions[?VpcId=='$v_id'].LoadBalancerName" --output text 2>/dev/null)
            for elb in $elbs_v1; do
              echo "   üóëÔ∏è Deletando Classic ELB: $elb"
              aws elb delete-load-balancer --load-balancer-name "$elb" 2>/dev/null
            done
            if [[ -n "$elbs_v2$elbs_v1" ]]; then sleep 30; fi

            # 6.3 NAT Gateways
            echo "   ‚è≥ Verificando NAT Gateways..."
            nat_gws=$(aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=$v_id" --query "NatGateways[?State!='deleted'].NatGatewayId" --output text 2>/dev/null)
            for nat in $nat_gws; do
              echo "   üóëÔ∏è Deletando NAT Gateway: $nat"
              aws ec2 delete-nat-gateway --nat-gateway-id "$nat" 2>/dev/null
            done
            if [[ -n "$nat_gws" ]]; then sleep 60; fi

            # 6.4 Security Groups
            echo "   üóëÔ∏è Limpando Security Groups..."
            sgs=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$v_id" --query "SecurityGroups[?GroupName!='default'].GroupId" --output text)
            for sg in $sgs; do
               aws ec2 delete-security-group --group-id "$sg" 2>/dev/null && echo "   ‚úÖ SG $sg removido"
            done

            # 6.5 ENIs (Deep Audit)
            echo "   üóëÔ∏è Limpando interfaces de Rede (ENIs)..."
            enis=$(aws ec2 describe-network-interfaces --filters "Name=vpc-id,Values=$v_id" --query 'NetworkInterfaces[*].NetworkInterfaceId' --output text)
            for eni in $enis; do
              desc=$(aws ec2 describe-network-interfaces --network-interface-ids "$eni" --query 'NetworkInterfaces[0].Description' --output text 2>/dev/null)
              status=$(aws ec2 describe-network-interfaces --network-interface-ids "$eni" --query 'NetworkInterfaces[0].Status' --output text 2>/dev/null)
              echo "      üïµÔ∏è Investigando ENI $eni ($status): $desc"
              
              att_id=$(aws ec2 describe-network-interfaces --network-interface-ids "$eni" --query 'NetworkInterfaces[0].Attachment.AttachmentId' --output text 2>/dev/null)
              if [[ "$att_id" != "None" && -n "$att_id" ]]; then
                aws ec2 detach-network-interface --attachment-id "$att_id" --force 2>/dev/null || true
              fi
              
              if aws ec2 delete-network-interface --network-interface-id "$eni" 2>&1; then
                echo "      ‚úÖ ENI $eni removida"
              else
                echo "      ‚ùå ENI $eni ainda em uso por: $desc"
              fi
            done

            # 6.6 IGWs
            echo "   üóëÔ∏è Limpando Internet Gateways..."
            igws=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$v_id" --query 'InternetGateways[*].InternetGatewayId' --output text)
            for ig_id in $igws; do
              aws ec2 detach-internet-gateway --internet-gateway-id "$ig_id" --vpc-id "$v_id" 2>/dev/null
              aws ec2 delete-internet-gateway --internet-gateway-id "$ig_id" 2>/dev/null && echo "   ‚úÖ IGW $ig_id removido"
            done

            # 6.7 Subnets (v7 - Heavy Retry)
            echo "   üóëÔ∏è Limpando Subnets..."
            for retry in {1..5}; do
              subs=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$v_id" --query 'Subnets[*].SubnetId' --output text)
              if [[ -z "$subs" ]]; then break; fi
              for s_id in $subs; do
                aws ec2 delete-subnet --subnet-id "$s_id" 2>&1 && echo "      ‚úÖ Subnet $s_id removida" || echo "      ‚è≥ Subnet $s_id bloqueada..."
              done
              if [[ $retry -lt 5 ]]; then sleep 15; fi
            done

            # 6.8 VPC finalize
            echo "   üí£ Finalizando exclus√£o da VPC: $v_id"
            if aws ec2 delete-vpc --vpc-id "$v_id" 2>&1; then
              echo "   ‚≠ê VPC $v_id Removida com sucesso!"
            else
               echo "   ‚ö†Ô∏è VPC $v_id ainda possui depend√™ncias ocultas. Aguarde o ECS/RDS terminar de liberar as ENIs."
            fi
          done
          echo "‚ú® Limpeza conclu√≠da!"
