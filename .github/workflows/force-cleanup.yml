name: ğŸ§¹ Force Cleanup Orphaned Resources

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Digite "CLEANUP" para confirmar a exclusÃ£o dos recursos conflitantes'
        required: true
        default: ''

jobs:
  cleanup:
    name: ğŸ§¹ AWS Resource Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "CLEANUP" ]]; then
            echo "âŒ ConfirmaÃ§Ã£o invÃ¡lida. Digite CLEANUP para prosseguir."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Delete Orphaned Resources
        run: |
          echo "ğŸš€ Iniciando limpeza de recursos Ã³rfÃ£os..."

          # FunÃ§Ãµes auxiliares para nÃ£o falhar o script se o recurso nÃ£o existir
          delete_ecr() {
            repo=$1
            echo "ğŸ—‘ï¸ Verificando ECR: $repo"
            aws ecr delete-repository --repository-name $repo --force 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado ou erro"
          }

          delete_rds_subnet() {
            name=$1
            echo "ğŸ—‘ï¸ Verificando RDS Subnet Group: $name"
            aws rds delete-db-subnet-group --db-subnet-group-name $name 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado ou erro"
          }

          delete_rds_param() {
            name=$1
            echo "ğŸ—‘ï¸ Verificando RDS Param Group: $name"
            aws rds delete-db-parameter-group --db-parameter-group-name $name 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado ou erro"
          }

          delete_s3() {
            bucket=$1
            echo "ğŸ—‘ï¸ Verificando S3 Bucket: $bucket"
            # Tenta esvaziar primeiro
            aws s3 rm s3://$bucket --recursive 2>/dev/null
            aws s3 rb s3://$bucket --force 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado ou erro"
          }

          delete_iam_role() {
            role=$1
            echo "ğŸ—‘ï¸ Verificando IAM Role: $role"
            # Remove policies anexadas antes
            policies=$(aws iam list-attached-role-policies --role-name $role --query 'AttachedPolicies[*].PolicyArn' --output text 2>/dev/null)
            for policy in $policies; do
              aws iam detach-role-policy --role-name $role --policy-arn $policy 2>/dev/null
            done
            aws iam delete-role --role-name $role 2>/dev/null && echo "   âœ… Deletado" || echo "   âš ï¸ NÃ£o encontrado ou erro"
          }

          # 1. Limpar ECR Repos (nomes antigos hardcoded)
          echo "ğŸ“¦ Limpando ECR Repositories..."
          delete_ecr "nexus-sus-etl"
          delete_ecr "nexus-sus-frontend"
          delete_ecr "nexus-sus-engine"
          delete_ecr "nexus-sus-api"

          # 2. Limpar RDS
          echo "ğŸ—„ï¸ Limpando RDS..."
          delete_rds_subnet "nexus-sus-db-subnet-group"
          delete_rds_param "nexus-sus-postgres-params"

          # 3. Limpar S3
          echo "ğŸª£ Limpando S3..."
          delete_s3 "nexus-sus-data-lake"

          # 4. Limpar IAM
          echo "ğŸ”‘ Limpando IAM..."
          delete_iam_role "nexus-sus-etl-role"

          echo "âœ… Limpeza concluÃ­da! Agora vocÃª pode rodar o Terraform Apply."
