name: Production-Grade Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  infra-and-deploy:
    name: Provision & Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://nexus-sus-alb-prod-XXXXX.us-east-1.elb.amazonaws.com
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Clean Cache
        run: |
          rm -rf infra/.terraform
          rm -rf infra/.terraform.lock.hcl
          rm -rf infra/terraform.tfstate*
          rm -rf ~/.terraform*
          echo "✅ Cache limpo"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Backup State
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp s3://nexus-sus-terraform-state/prod/terraform.tfstate \
            s3://nexus-sus-terraform-state/prod/terraform.tfstate.backup.$(date +%s) || true
          echo "✅ State backed up"

      - name: Import Existing Resources
        working-directory: infra
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_environment: prod
          TF_VAR_db_username: nexus_admin
          TF_VAR_admin_password: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform init \
            -backend-config="bucket=nexus-sus-terraform-state" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=nexus-sus-terraform-locks"
          
          terraform import aws_iam_policy.etl_s3_read arn:aws:iam::629614691528:policy/nexus-sus-etl-s3-read-policy-prod || true
          terraform import aws_iam_policy.etl_s3_write arn:aws:iam::629614691528:policy/nexus-sus-etl-s3-write-policy-prod || true
          terraform import aws_iam_policy.etl_ecr_access arn:aws:iam::629614691528:policy/nexus-sus-etl-ecr-access-policy-prod || true
          terraform import aws_iam_policy.ecs_logging arn:aws:iam::629614691528:policy/nexus-sus-ecs-logging-policy-prod || true
          
          echo "✅ Resources imported successfully"

      - name: Terraform Plan
        working-directory: infra
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_environment: prod
          TF_VAR_db_username: nexus_admin
          TF_VAR_admin_password: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform plan -var-file="prod.tfvars" -out=tfplan
          echo "✅ Plan successful"

      - name: Terraform Apply
        working-directory: infra
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_environment: prod
          TF_VAR_db_username: nexus_admin
          TF_VAR_admin_password: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform apply -auto-approve tfplan
          echo "✅ Apply successful - Production is LIVE!"

      - name: Validate Deployment
        run: |
          echo "✅ Deployment complete"
          echo "Check your application at the ALB endpoint in AWS Console"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag and Push Images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/nexus-sus-api-prod:latest -f api/Dockerfile .
          docker push $ECR_REGISTRY/nexus-sus-api-prod:latest
          
          docker build -t $ECR_REGISTRY/nexus-sus-frontend-prod:latest ./nexus-sus-frontend
          docker push $ECR_REGISTRY/nexus-sus-frontend-prod:latest

      - name: Update ECS Services
        run: |
          aws ecs update-service --cluster nexus-sus-cluster-prod --service nexus-sus-api-service-prod --force-new-deployment
          aws ecs update-service --cluster nexus-sus-cluster-prod --service nexus-sus-frontend-service-prod --force-new-deployment
