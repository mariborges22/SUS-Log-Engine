name: üîÑ ETL Pipeline (S3 -> RDS)

on:
  schedule:
    - cron: '0 2 * * *'  # Agendado para 2:00 AM UTC diariamente
  workflow_dispatch:      # Gatilho manual para testes

jobs:
  etl_process:
    name: üè≠ Run ETL Data Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Create Lambda Deployment Package
        run: |
          mkdir -p package
          
          # 1. Instalar depend√™ncias no diret√≥rio pacote
          # Usa --platform manylinux2014_x86_64 --only-binary=:all: para garantir compatibilidade com Lambda
          pip install \
            --platform manylinux2014_x86_64 \
            --target ./package \
            --implementation cp \
            --python-version 3.11 \
            --only-binary=:all: --upgrade \
            pandas sqlalchemy psycopg2-binary boto3

          # 2. Copiar script ETL e SQL Schema
          cp nexus-sus-etl/extrair_sus.py ./package/
          cp nexus-sus-etl/create_table.sql ./package/
          
          # 3. Zipar tudo
          cd package
          zip -r ../deployment_package.zip .
          cd ..
          
          echo "üì¶ Pacote ZIP criado: deployment_package.zip"

      - name: üöÄ Deploy & Invoke Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          LAMBDA_NAME: "nexus-sus-etl-staging" # Assumindo staging, ou use l√≥gica de env
        run: |
          # Define Environment logic equivalent to Deploy workflow
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            LAMBDA_NAME="nexus-sus-etl-production"
          else
             LAMBDA_NAME="nexus-sus-etl-staging"
          fi
        
          echo "üöÄ Updating Lambda Code for: $LAMBDA_NAME"
          aws lambda update-function-code \
            --function-name $LAMBDA_NAME \
            --zip-file fileb://deployment_package.zip

          echo "‚è≥ Waiting for update..."
          sleep 10
          
          echo "‚ö° Invoking Lambda..."
          aws lambda invoke \
            --function-name $LAMBDA_NAME \
            --cli-binary-format raw-in-base64-out \
            --payload '{}' \
            response.json
            
          echo "üìÑ Lambda Output:"
          cat response.json
          
          if grep -q "ErrorMessage" response.json; then
            echo "‚ùå ETL Falhou!"
            exit 1
          fi

      - name: ‚úÖ Notify Success
        if: success()
        run: echo "ETL (Lambda) Conclu√≠do com Sucesso!"

      - name: ‚ùå Notify Failure
        if: failure()
        run: echo "ETL Falhou. Verifique os logs da Lambda no CloudWatch."
